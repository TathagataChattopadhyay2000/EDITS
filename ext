model {

  for (k in 1:K) {
    for (i in 1:n[k]) {
      y[k,i] ~ dnorm(mu[k], prec_sigma)
    }
    mu[k] ~ dnorm(mu_pop, prec_tau)
  }

  mu_pop     ~ dnorm(mu_pop_mean, prec_mu_pop)
  prec_tau   ~ dgamma(tau_shape,   tau_rate)
  prec_sigma ~ dgamma(sigma_shape, sigma_rate)
}


# Simple default prior factory for the normal model
getPriorParametersNormal <- function(
  mu_pop_mean = 0,
  mu_pop_sd   = 100,   # very vague: prec_mu_pop = 1 / 100^2 = 1e-4
  tau_shape   = 0.5,
  tau_rate    = 0.05,
  sigma_shape = 0.5,
  sigma_rate  = 0.05
) {
  if (!is.single.numeric(mu_pop_mean))
    stop("mu_pop_mean must be a single numeric.")
  if (!is.single.positive.numeric(mu_pop_sd))
    stop("mu_pop_sd must be a single positive numeric.")
  if (!is.single.positive.numeric(tau_shape))
    stop("tau_shape must be a single positive numeric.")
  if (!is.single.positive.numeric(tau_rate))
    stop("tau_rate must be a single positive numeric.")
  if (!is.single.positive.numeric(sigma_shape))
    stop("sigma_shape must be a single positive numeric.")
  if (!is.single.positive.numeric(sigma_rate))
    stop("sigma_rate must be a single positive numeric.")

  prior_parameters <- list(
    mu_pop_mean = mu_pop_mean,
    mu_pop_sd   = mu_pop_sd,
    tau_shape   = tau_shape,
    tau_rate    = tau_rate,
    sigma_shape = sigma_shape,
    sigma_rate  = sigma_rate
  )

  class(prior_parameters) <- "prior_parameters_normal"
  prior_parameters
}

# Manual override version â€“ same arguments, no defaults
setPriorParametersNormal <- function(
  mu_pop_mean,
  mu_pop_sd,
  tau_shape,
  tau_rate,
  sigma_shape,
  sigma_rate
) {
  if (missing(mu_pop_mean)) stop("Please provide 'mu_pop_mean'.")
  if (missing(mu_pop_sd))   stop("Please provide 'mu_pop_sd'.")
  if (missing(tau_shape))   stop("Please provide 'tau_shape'.")
  if (missing(tau_rate))    stop("Please provide 'tau_rate'.")
  if (missing(sigma_shape)) stop("Please provide 'sigma_shape'.")
  if (missing(sigma_rate))  stop("Please provide 'sigma_rate'.")

  getPriorParametersNormal(
    mu_pop_mean = mu_pop_mean,
    mu_pop_sd   = mu_pop_sd,
    tau_shape   = tau_shape,
    tau_rate    = tau_rate,
    sigma_shape = sigma_shape,
    sigma_rate  = sigma_rate
  )
}


prepareAnalysisNormal <- function(prior_parameters = NULL) {

  if (is.null(prior_parameters)) {
    prior_parameters <- getPriorParametersNormal()
  } else {
    if (!inherits(prior_parameters, "prior_parameters_normal")) {
      stop("prior_parameters must have class 'prior_parameters_normal'")
    }
  }

  j_data <- list(
    mu_pop_mean = prior_parameters$mu_pop_mean,
    prec_mu_pop = 1 / prior_parameters$mu_pop_sd^2,
    tau_shape   = prior_parameters$tau_shape,
    tau_rate    = prior_parameters$tau_rate,
    sigma_shape = prior_parameters$sigma_shape,
    sigma_rate  = prior_parameters$sigma_rate
  )

  j_model_file <- system.file(
    package   = "bhmbasket",
    "jags_models",
    "bhm_normal.txt",
    mustWork  = TRUE
  )

  j_parameters <- c("mu", "mu_pop", "prec_tau", "prec_sigma")

  list(
    j_parameters = j_parameters,
    j_model_file = j_model_file,
    j_data       = j_data
  )
}


prep <- prepareAnalysisNormal(prior_parameters = prior_parameters_normal)
posterior_samples <- getPosteriorsNormal(
  j_parameters = prep$j_parameters,
  j_model_file = prep$j_model_file,
  j_data       = prep$j_data,
  n_mcmc_iterations = n_mcmc_iterations
)

