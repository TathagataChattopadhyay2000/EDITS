#' @title simulateScenarios
#' @description This function creates scenarios for the analysis with
#' \code{\link[bhmbasket]{performAnalyses}}.
#' @param n_subjects_list A list that contains for each scenario a vector for
#' the number of subjects per cohort.
#' A single vector can be provided if all scenarios should have the same number of subjects.
#' @param response_rates_list A list that contains for each scenario a vector for
#' the response rates per cohort.
#' @param scenario_numbers A vector of positive integers naming the scenarios,
#' Default: `seq_along(response_rates_list)`
#' @param n_trials An integer indicating the number of trial simulations per response rates,
#' Default: `10000`. If `n_trials` is present in `.GlobalEnv` and `missing(n_trials)`,
#' the globally available value will be used.
#' @return An object of class `scenario_list` with the scenario data for each specified scenario.
#' @details The function simulates trials with binary outcome for each scenario.
#' Integer values for the response rates will be treated as observed outcomes.
#' @author Stephan Wojciekowski
#' @seealso
#'  \code{\link[bhmbasket]{saveScenarios}}
#'  \code{\link[bhmbasket]{createTrial}}
#'  \code{\link[bhmbasket]{performAnalyses}}
#' @rdname simulateScenarios
#' @examples
#'   n_subjects     <- c(10, 20, 30)
#'
#'   rr_negative    <- rep(0.1, 3)
#'   rr_nugget      <- c(0.9, 0.1, 0.1)
#'   rr_positive    <- rep(0.9, 3)
#'
#'   scenarios_list <- simulateScenarios(
#'     n_subjects_list     = list(n_subjects,
#'                                n_subjects,
#'                                n_subjects),
#'     response_rates_list = list(rr_negative,
#'                                rr_nugget,
#'                                rr_positive))
#' @export
#' @md
simulateScenarios <- function (
  n_subjects_list,
  response_rates_list,
  scenario_numbers = seq_along(response_rates_list),
  n_trials         = 1e4
) {
  ## --- Basic structure checks ------------------------------------------------
  
  # response_rates_list: list of numeric vectors, no NAs
  checkmate::assert_list(
    response_rates_list,
    types       = "numeric",
    any.missing = FALSE,
    .var.name   = "response_rates_list"
  )
  
  # n_subjects_list: allow vector -> recycle to list
  if (!is.list(n_subjects_list)) {
    n_subjects_list <- rep(list(n_subjects_list), length(response_rates_list))
  }
  
  # list structure + no NAs
  checkmate::assert_list(
    n_subjects_list,
    types       = "numeric",
    any.missing = FALSE,
    .var.name   = "n_subjects_list"
  )
  
  # each element: positive integerish
  checkmate::assert_true(
    all(vapply(
      n_subjects_list,
      checkmate::test_integerish,
      logical(1),
      lower        = 1,
      any.missing  = FALSE
    )),
    .var.name = "Provide a list of vectors of positive integers for 'n_subjects_list'"
  )
  
  # scenario_numbers: positive integerish vector
  checkmate::assert_integerish(
    scenario_numbers,
    lower       = 1,
    any.missing = FALSE,
    .var.name   = "scenario_numbers"
  )
  
  ## --- Length compatibility --------------------------------------------------
  
  # 'scenario_numbers' and 'n_subjects_list' must have same length
  checkmate::assert_true(
    length(scenario_numbers) == length(n_subjects_list),
    .var.name = "'scenario_numbers' and 'n_subjects_list' must have same length"
  )
  
  # 'n_subjects_list' and 'response_rates_list' must have same length
  checkmate::assert_true(
    length(n_subjects_list) == length(response_rates_list),
    .var.name = "'n_subjects_list' and 'response_rates_list' must have same length"
  )
  
  ## --- Cohort consistency ----------------------------------------------------
  
  n_cohorts <- length(response_rates_list[[1L]])
  
  # each scenario must have at least 2 cohorts
  checkmate::assert_true(
    n_cohorts >= 2L,
    .var.name = "Each scenario must have at least 2 cohorts"
  )
  
  # all scenarios: same number of cohorts in response_rates_list
  cohort_lengths_rr <- vapply(response_rates_list, length, integer(1))
  checkmate::assert_true(
    all(cohort_lengths_rr == n_cohorts),
    .var.name = "All scenarios must have same number of cohorts in 'response_rates_list'"
  )
  
  # all scenarios: same number of cohorts in n_subjects_list
  cohort_lengths_ns <- vapply(n_subjects_list, length, integer(1))
  checkmate::assert_true(
    all(cohort_lengths_ns == n_cohorts),
    .var.name = "All scenarios must have same number of cohorts in 'n_subjects_list'"
  )
  
  ## --- Response rate semantics (match original element-wise rule) -----------
  # For each element r:
  #   either  0 < r < 1 (probability) OR
  #   integer and (r == 0 or r >= 1)   (historical / fixed)
  
  for (rates in response_rates_list) {
    # already numeric & NA-free from assert_list
  
    ok <- (rates > 0 & rates < 1) |
          (is.wholenumber(rates) & (rates == 0 | rates >= 1))
    
    checkmate::assert_true(
      all(ok),
      .var.name = paste(
        "Each element in 'response_rates_list' must be",
        "either a probability in (0, 1) or an integer equal to 0 or â‰¥ 1"
      )
    )
  }
  
  ## --- Logical consistency: n_subjects >= response_rates --------------------
  
  for (i in seq_along(n_subjects_list)) {
    checkmate::assert_true(
      all(n_subjects_list[[i]] >= response_rates_list[[i]]),
      .var.name = "Values in 'response_rates_list' must not exceed 'n_subjects_list'"
    )
  }
  
  ## --- n_trials: global override + validation -------------------------------
  
  # Original behaviour: if n_trials exists in .GlobalEnv and argument is missing,
  # use the global one. Then validate the *final* value.
  if ("n_trials" %in% ls(envir = .GlobalEnv) && missing(n_trials)) {
    n_trials <- get("n_trials", envir = .GlobalEnv)
  }
  
  # scalar, integerish, > 0
  checkmate::assert_count(
    n_trials,
    positive = TRUE,
    .var.name = "n_trials"
  )
  
  ## --- Scenario construction -------------------------------------------------
  
  scenario_list <- vector(mode = "list", length = length(scenario_numbers))
  
  for (s in seq_along(scenario_numbers)) {
    scenario_list[[s]] <- getScenario(
      n_subjects     = n_subjects_list[[s]],
      response_rates = response_rates_list[[s]],
      n_trials       = n_trials
    )
    scenario_list[[s]]$scenario_number <- scenario_numbers[s]
  }
  
  names(scenario_list) <- paste0("scenario_", scenario_numbers)
  class(scenario_list) <- "scenario_list"
  
  return(scenario_list)
}
