bin_codes <- matrix(NA_integer_, nrow(all_scenarios_y), n_cohorts)
colnames(bin_codes) <- cohort_names
for (j in seq_len(n_cohorts)) {
  bin_codes[, j] <- cut(
    all_scenarios_y[, j],
    breaks         = breaks[[j]],
    include.lowest = TRUE,
    labels         = FALSE
  )
}

## 3) group signature = (bin pattern across all cohorts) + n_subjects + go_flag
sig_matrix <- cbind(
  bin_codes,
  all_scenarios_n_subjects,
  go_flag = all_scenarios_overall_gos
)
signature <- getHashKeys(sig_matrix)

sig_levels  <- unique(signature)
group_id    <- match(signature, sig_levels)
group_sizes <- as.integer(tabulate(group_id, nbins = length(sig_levels)))

## 4) representative per group ONLY if group size > 1, else keep original y
y_rep <- all_scenarios_y
colnames(y_rep) <- cohort_names

rep_matrix <- matrix(NA_real_, nrow = length(sig_levels), ncol = n_cohorts)
colnames(rep_matrix) <- cohort_names

for (g in seq_along(sig_levels)) {
  idx <- which(group_id == g)
  if (length(idx) > 1) {
    for (j in seq_len(n_cohorts)) {
      vals <- all_scenarios_y[idx, j]
      rep_matrix[g, j] <- (min(vals) + max(vals)) / 2   # midpoint of values in the group
      ## if you want mean instead: rep_matrix[g, j] <- mean(vals)
    }
    y_rep[idx, ] <- matrix(rep_matrix[g, ], nrow = length(idx), byrow = TRUE)
  }
}

out <- getUniqueRows(cbind(
  y_rep,
  all_scenarios_n_subjects,
  go_flag = all_scenarios_overall_gos
))

attr(out, "bin_breaks")   <- breaks
attr(out, "group_levels") <- sig_levels
attr(out, "group_sizes")  <- group_sizes
attr(out, "rep_matrix")   <- rep_matrix

return(out)
