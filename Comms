getScenario <- function (

  n_subjects,
  response_rates,

  cohort_names = seq_along(n_subjects),

  n_trials     = 1e4

) {

  response_rates           <- convertVector2Matrix(response_rates)
  colnames(response_rates) <- paste0("rr_", cohort_names)

  if (any(response_rates < 1 & response_rates > 0)) {

    ## Simulations for new cohorts
    ## A cohort is new if it has a response rate greater than 0 and less than 1.
    ## Response rates equal to 0 or
    ## greater than or equal to 1 will be used as fixed responses.

    new_cohorts <- TRUE
    index_new   <- which(response_rates < 1 & response_rates > 0)

    if (length(n_subjects[index_new]) != length(response_rates[, index_new])) {
      stop ("n_subjects and response_rates must have same length")
    }

    ## Simulate the number of responses without interim analysis
    n_responders <- getResponders(
      response_rates = response_rates[, index_new],
      n_subjects     = n_subjects[index_new],
      n_trials       = n_trials)

  } else {

    ## No new cohorts, as response rates are all greater than or equal to 1

    new_cohorts <- FALSE

  }

  if (any(response_rates >= 1 | response_rates == 0)) {

    ## Historical cohorts

    hist_cohorts <- TRUE
    index_hist   <- which(response_rates >= 1 | response_rates == 0)

    if (length(n_subjects[index_hist]) != length(response_rates[, index_hist])) {
      stop ("n_subjects and response_rates must have same length")
    }

    if (new_cohorts) {

      ## In case of simulated (new) cohorts, the historic responses will be recycled to match
      ## the number of unique trials

      ## Make matrix if necessary
      n_responders_hist <-  matrix(rep(response_rates[index_hist],
                                       each = nrow(n_responders)),
                                   nrow = nrow(n_responders))

    } else {

      ## In case of no simulated cohorts, only one set of fixed responses is needed

      n_responders_hist <- matrix(response_rates[index_hist], nrow = 1)

    }

  } else {

    ## No historical cohorts, as response rates are all smaller than 1

    hist_cohorts <- FALSE

  }

  ## Combine new and historical cohorts as appropriate
  if (new_cohorts & hist_cohorts) {

    n_responders <- cbind(n_responders, n_responders_hist)

  } else if (hist_cohorts) {

    n_responders <- n_responders_hist

  }

  previous_gos <- matrix(TRUE, byrow = TRUE,
                         ncol = length(n_subjects) + 1L,
                         nrow = nrow(n_responders))
  colnames(previous_gos) <- c("overall", paste0("decision_", cohort_names))

  n_subjects <- matrix(n_subjects, byrow = TRUE,
                       ncol = length(n_subjects),
                       nrow = nrow(n_responders))

  colnames(n_subjects)   <- paste0("n_", cohort_names)
  colnames(n_responders) <- paste0("r_", cohort_names)


  ## Create list to return data
  scenario_data <- list(n_subjects        = n_subjects,
                        n_responders      = n_responders,
                        response_rates    = response_rates,
                        previous_analyses = list(go_decisions   = previous_gos,
                                                 post_quantiles = NULL),
                        n_trials          = n_trials)

  return (scenario_data)

}

getScenario <- function(n_subjects, response_rates, 
                        cohort_names = seq_along(n_subjects), n_trials = 1e4
) {
  # Validation
  checkmate::assert_integerish(n_subjects, lower = 0, any.missing = FALSE)
  
  checkmate::assert_numeric(response_rates, any.missing = FALSE)
  
  checkmate::assert_integerish(n_trials, lower = 1, any.missing = FALSE, len = 1)
  
  checkmate::assert_true(length(cohort_names) == length(n_subjects),
                         .var.name = "cohort_names must match length of n_subjects")
  
  # Preparing response_rates matrix & names
  response_rates            <- convertVector2Matrix(response_rates)
  cohort_names_chr          <- as.character(cohort_names)
  colnames(response_rates)  <- paste0("rr_", cohort_names_chr)
  
  # Flags
  new_cohorts  <- FALSE
  hist_cohorts <- FALSE
  
  # New cohorts: 0 < rr < 1
  if (any(response_rates < 1 & response_rates > 0)) {
    new_cohorts <- TRUE
    index_new   <- which(response_rates < 1 & response_rates > 0)
    
    # Match original check (length on sliced matrix/vector)
    checkmate::assert_true(
      
      length(n_subjects[index_new]) == length(response_rates[, index_new]),
      
      .var.name = "n_subjects and response_rates must have same length"
      
    )
    
    n_responders <- getResponders(
      response_rates = response_rates[, index_new, drop = FALSE],
      n_subjects     = n_subjects[index_new],
      n_trials       = n_trials
    )
  }
  
  # Historical cohorts: rr >= 1 OR rr == 0
  if (any(response_rates >= 1 | response_rates == 0)) {
    hist_cohorts <- TRUE
    index_hist   <- which(response_rates >= 1 | response_rates == 0)
    
    checkmate::assert_true(
      
      length(n_subjects[index_hist]) == length(response_rates[, index_hist]),
      
      .var.name = "n_subjects and response_rates must have same length"
      
    )
    
    if (new_cohorts) {
      # Recycle fixed responses to match  no. of rows in simulated responders
      n_responders_hist <- matrix(
        rep(response_rates[index_hist], each = nrow(n_responders)),
        nrow = nrow(n_responders)
      )
    } else {
      # No simulated cohorts: single set of fixed responses
      n_responders_hist <- matrix(response_rates[index_hist], nrow = 1)
    }
  }
  
  # Combine responders as needed
  if (isTRUE(new_cohorts) && isTRUE(hist_cohorts)) {
    
    n_responders <- cbind(n_responders, n_responders_hist)
    
  } else if (isTRUE(hist_cohorts) && !isTRUE(new_cohorts)) {
    
    n_responders <- n_responders_hist
    
  }
  
  previous_gos <- matrix(
    TRUE, byrow = TRUE,
    ncol = length(n_subjects) + 1L,
    nrow = nrow(n_responders)
  )
  colnames(previous_gos) <- c("overall", paste0("decision_", cohort_names_chr))
  
  n_subjects_mat <- matrix(
    n_subjects, byrow = TRUE,
    ncol = length(n_subjects),
    nrow = nrow(n_responders)
  )
  
  colnames(n_subjects_mat) <- paste0("n_", cohort_names_chr)
  colnames(n_responders)   <- paste0("r_", cohort_names_chr)
  
  # Return list (structure unchanged)
  scenario_data <- list(
    n_subjects        = n_subjects_mat,
    n_responders      = n_responders,
    response_rates    = response_rates,
    previous_analyses = list(
      go_decisions   = previous_gos,
      post_quantiles = NULL
    ),
    n_trials          = n_trials
  )
  
  return(scenario_data)
}
