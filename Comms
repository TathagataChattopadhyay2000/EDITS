saveAnalyses <- function (
  
  analysis_list,
  save_path = tempdir()
  
) {
  # --- Argument validation ----------------------------------------------------
  checkmate::assertClass(
    analysis_list,
    "analysis_list",
    .var.name = "analysis_list"
  )
  
  checkmate::assert_character(
    save_path,
    len         = 1,
    any.missing = FALSE,
    .var.name   = "save_path"
  )
  
  # --- Ensure directory exists -----------------------------------------------
  if (!dir.exists(save_path)) {
    dir.create(save_path, recursive = TRUE)
  }
  
  # --- Extract scenario & analysis numbers -----------------------------------
  scenario_numbers <- vapply(
    analysis_list,
    function(x) x$scenario_data$scenario_number,
    FUN.VALUE = numeric(1)
  )
  
  # If an analysis_number is stored in analysis_parameters, use it.
  # Otherwise default to 1 for each scenario (matches the example in the docs).
  analysis_numbers <- vapply(
    analysis_list,
    function(x) {
      if (!is.null(x$analysis_parameters$analysis_number)) {
        as.integer(x$analysis_parameters$analysis_number)
      } else {
        1L
      }
    },
    FUN.VALUE = integer(1)
  )
  
  # --- Save each scenario's analysis object ----------------------------------
  for (s in seq_along(analysis_list)) {
    saveRDS(
      analysis_list[[s]],
      file = file.path(
        save_path,
        paste0(
          "analysis_data_",
          scenario_numbers[s], "_",
          analysis_numbers[s], ".rds"
        )
      )
    )
  }
  
  # --- Return metadata used by loadAnalyses() --------------------------------
  return(list(
    scenario_numbers = scenario_numbers,
    analysis_numbers = analysis_numbers,
    path             = save_path
  ))
}


context("saveAnalyses")

## 1. Happy path: saves files and can be reloaded via loadAnalyses -------------

test_that("saveAnalyses: saves analysis_list to disk and loadAnalyses can read it back", {
  set.seed(101)
  
  # Create a small but real analysis_list with 2 scenarios
  scen <- simulateScenarios(
    n_subjects_list     = list(c(10, 20),
                               c(15, 25)),
    response_rates_list = list(c(0.3, 0.6),
                               c(0.5, 0.8)),
    n_trials            = 20
  )
  
  analyses <- performAnalyses(
    scenario_list      = scen,
    method_names       = "pooled",
    target_rates       = c(0.5, 0.5),
    n_mcmc_iterations  = 20,
    verbose            = FALSE
  )
  
  tmp_dir <- tempdir()
  
  # Call function under test
  info <- saveAnalyses(analyses, save_path = tmp_dir)
  
  # Returned metadata must have the right shape
  expect_true(is.list(info))
  expect_equal(length(info$scenario_numbers), length(analyses))
  expect_equal(length(info$analysis_numbers), length(analyses))
  expect_identical(info$path, tmp_dir)
  
  # scenario_numbers in info must match those stored inside the analysis_list
  internal_scen <- vapply(
    analyses,
    function(x) x$scenario_data$scenario_number,
    FUN.VALUE = numeric(1)
  )
  expect_identical(info$scenario_numbers, internal_scen)
  
  # The corresponding RDS files should exist on disk
  for (i in seq_along(info$scenario_numbers)) {
    f <- file.path(
      tmp_dir,
      paste0("analysis_data_",
             info$scenario_numbers[i], "_",
             info$analysis_numbers[i], ".rds")
    )
    expect_true(file.exists(f),
                info = paste("Expected file to exist:", f))
  }
  
  # loadAnalyses should be able to read those back into an analysis_list
  loaded <- loadAnalyses(
    scenario_numbers = info$scenario_numbers,
    analysis_numbers = info$analysis_numbers,
    load_path        = info$path
  )
  
  expect_s3_class(loaded, "analysis_list")
  expect_identical(length(loaded), length(analyses))
  expect_identical(names(loaded), names(analyses))
})


## 2. Validation: non-analysis_list input is rejected --------------------------

test_that("saveAnalyses: non-analysis_list input triggers a class error", {
  # We pass a plain list instead of a proper analysis_list â†’ should fail fast
  expect_error(
    saveAnalyses(list(a = 1)),
    "analysis_list",
    ignore.case = TRUE
  )
})


## 3. Validation: save_path must be a single string ----------------------------

test_that("saveAnalyses: save_path must be a character vector of length 1", {
  set.seed(202)
  
  # Create a small valid analysis_list to isolate the save_path check
  scen <- simulateScenarios(
    n_subjects_list     = list(c(10, 20)),
    response_rates_list = list(c(0.3, 0.6)),
    n_trials            = 10
  )
  
  analyses <- performAnalyses(
    scenario_list      = scen,
    method_names       = "pooled",
    target_rates       = c(0.5, 0.5),
    n_mcmc_iterations  = 10,
    verbose            = FALSE
  )
  
  # Vector of length > 1 should violate assert_character(len = 1)
  expect_error(
    saveAnalyses(analyses, save_path = c("a", "b")),
    "save_path",
    ignore.case = TRUE
  )
})
