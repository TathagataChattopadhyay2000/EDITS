test_that("mapUniqueTrials: without previous trials, maps unique trial quantiles back per scenario", {
  foreach::registerDoSEQ()
  
  n_resp <- rbind(c(1, 2),
                  c(2, 1))
  n_subj <- rbind(c(10, 10),
                  c(10, 10))
  
  resp_rates <- n_resp / n_subj
  
  scenario_list <- simulateScenarios(
    n_subjects_list     = list(n_subj[1, ]),     # c(10, 10)
    response_rates_list = list(resp_rates[1, ]), # c(0.1, 0.2)
    n_trials            = nrow(n_resp)           # 2 trials
  )

  scenario_list[[1]]$n_responders <- n_resp
  scenario_list[[1]]$n_subjects   <- n_subj
  
  trials_unique <- getUniqueTrials(scenario_list)
  n_cohorts     <- (ncol(trials_unique) - 1L) / 2L
  
  applicable_previous_trials <- FALSE
  
  calc_trial_indices <- rep(TRUE, nrow(trials_unique))
  
  trials_unique_calc <- trials_unique[calc_trial_indices, -ncol(trials_unique)]
  n_responders_u     <- trials_unique_calc[, seq_len(n_cohorts), drop = FALSE]
  n_subjects_u       <- trials_unique_calc[, seq_len(n_cohorts) + n_cohorts, drop = FALSE]
  
  
  expect_setequal(
    getHashKeys(trials_unique_calc),
    getHashKeys(cbind(n_resp, n_subj))
  )
  
  quantiles <- c(0.025, 0.5, 0.975)
  j_data    <- list(a = 1, b = 1)  # Beta(1,1) prior for pooled
  
  method_quantiles_list <- list(
    pooled = getPostQuantiles(
      method_name       = "pooled",
      quantiles         = quantiles,
      scenario_data     = list(n_subjects   = n_subjects_u,
                               n_responders = n_responders_u),
      calc_differences  = NULL,
      j_parameters      = NULL,
      j_model_file      = NULL,
      j_data            = j_data,
      n_mcmc_iterations = 1000,
      save_path         = NULL,
      save_trial        = NULL
    )
  )
  
  out <- mapUniqueTrials(
    scenario_list              = scenario_list,
    method_quantiles_list      = method_quantiles_list,
    trials_unique_calc         = trials_unique_calc,
    applicable_previous_trials = applicable_previous_trials
  )
  
  expect_type(out, "list")
  expect_identical(names(out), "scenario_1")
  
  scen1 <- out[["scenario_1"]]
  expect_true(is.list(scen1))
  expect_true("pooled" %in% names(scen1))
  
  # The per-trial matrices returned by mapUniqueTrials should match
  # exactly the ones produced by getPostQuantiles for the unique trials
  expect_identical(scen1$pooled[[1]], method_quantiles_list$pooled[[1]])
  expect_identical(scen1$pooled[[2]], method_quantiles_list$pooled[[2]])
})





})
── Error: mapUniqueTrials: without previous trials, maps unique trial quantiles back per scenario ────────────────────────────────────────────────
Error in `{
    scenario_data_matrix <- cbind(scenario_list[[k]]$n_responders, 
        scenario_list[[k]]$n_subjects)
    if (applicable_previous_trials) {
        scenario_go_flags <- scenario_list[[k]]$previous_analyses$go_decisions[, 
            1] > 0
        scenario_method_quantiles <- scenario_list[[k]]$previous_analyses$post_quantiles
    }
    else {
        scenario_go_flags <- rep(TRUE, length = nrow(scenario_data_matrix))
        scenario_method_quantiles <- vector(mode = "list", length = length(method_names))
        names(scenario_method_quantiles) <- method_names
    }
    if (any(scenario_go_flags)) {
        scenario_data_matrix_go <- convertVector2Matrix(scenario_data_matrix[scenario_go_flags, 
            ])
        search_keys <- getHashKeys(scenario_data_matrix_go)
        for (n in seq_along(method_names)) {
            scenario_method_quantiles[[method_names[n]]][scenario_go_flags] <- getHashValues(search_keys, 
                hash_tables_list[[n]])
        }
    }
    return(scenario_method_quantiles)
}`: task 1 failed - "value for ‘x1:1|x2:2|x3:10|x4:10’ not found"
Backtrace:
    ▆
 1. └─bhmbasket:::mapUniqueTrials(...)
 2.   └─... %do% ... at bhmbasket/R/AnalysisFunctions.R:577:3
 3.     └─e$fun(obj, substitute(ex), parent.frame(), e$data)
