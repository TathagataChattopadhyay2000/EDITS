go_prob_overall_interim <- function(n,
                                    p_true_vec,
                                    p_beta_vec,
                                    gamma_interim,
                                    gamma_final,
                                    overall_min_gos = 1L,
                                    n_trials,
                                    method_name = "stratified") {
  stopifnot(length(p_true_vec) == 2L, length(p_beta_vec) == 2L)

  n_int  <- floor(n / 2)
  n_add  <- n - n_int
  cohort_names <- c("p_1", "p_2")

  # ---------- Stage 1: simulate, analyse, interim decisions ----------
  scen_stage1 <- simulateScenarios(
    n_subjects_list     = list(rep(n_int, 2L)),
    response_rates_list = list(p_true_vec),
    n_trials            = n_trials
  )

  analysis_stage1 <- performAnalyses(
    scenario_list      = scen_stage1,
    evidence_levels    = c(gamma_interim, gamma_interim),
    target_rates       = p_beta_vec,
    method_names       = method_name,
    n_mcmc_iterations  = 100,
    verbose            = FALSE
  )

  decisions_stage1 <- getGoDecisions(
    analyses_list   = analysis_stage1,
    cohort_names    = cohort_names,
    evidence_levels = c(gamma_interim, gamma_interim),
    boundary_rules  = quote(c(
      x[1] > p_beta_vec[1],
      x[2] > p_beta_vec[2]
    )),
    overall_min_gos = overall_min_gos
  )

  overall_stage1 <- decisions_stage1$scenario_1$decisions_list[[method_name]]$overall

  # ---------- Stage 2: continue recruitment, analyse final ----------
  scen_stage2 <- continueRecruitment(
    n_subjects_add_list = list(rep(n_add, 2L)),
    decisions_list      = decisions_stage1,
    method_name         = method_name
  )

  analysis_stage2 <- performAnalyses(
    scenario_list      = scen_stage2,
    evidence_levels    = c(gamma_final, gamma_final),
    target_rates       = p_beta_vec,
    method_names       = method_name,
    n_mcmc_iterations  = 100,
    verbose            = FALSE
  )

  decisions_stage2 <- getGoDecisions(
    analyses_list   = analysis_stage2,
    cohort_names    = cohort_names,
    evidence_levels = c(gamma_final, gamma_final),
    boundary_rules  = quote(c(
      x[1] > p_beta_vec[1],
      x[2] > p_beta_vec[2]
    )),
    overall_min_gos = overall_min_gos
  )

  overall_final <- decisions_stage2$scenario_1$decisions_list[[method_name]]$overall

  # early futility: if interim overall == FALSE â†’ cannot be Go at the end
  overall_final_adj <- ifelse(overall_stage1, overall_final, FALSE)

  mean(overall_final_adj)
}
