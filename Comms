test_that("mapUniqueTrials: without previous trials, maps unique trial quantiles back per scenario", {
  foreach::registerDoSEQ()
  
  # Two trials, 2 cohorts
  n_resp <- rbind(
    c(1, 2),
    c(2, 1)
  )
  n_subj <- rbind(
    c(10, 10),
    c(10, 10)
  )
  
  # Build scenario_list via simulateScenarios + overwrite counts
  resp_rates <- n_resp / n_subj
  
  scenario_list <- simulateScenarios(
    n_subjects_list     = list(n_subj[1, ]),     # c(10, 10)
    response_rates_list = list(resp_rates[1, ]), # c(0.1, 0.2)
    n_trials            = nrow(n_resp)           # 2 trials
  )
  
  scenario_list[[1]]$n_responders <- n_resp
  scenario_list[[1]]$n_subjects   <- n_subj
  class(scenario_list) <- "scenario_list"
  
  # ----- Build trials_unique_calc in the same "shape" mapUniqueTrials expects -----
  scenario_matrix    <- cbind(n_resp, n_subj)
  trials_unique_calc <- getUniqueRows(scenario_matrix)
  
  # IMPORTANT: harmonize column names with convertVector2Matrix()
  # mapUniqueTrials will call:
  #   scenario_data_matrix_go <- convertVector2Matrix(...)
  # so its hash keys use colnames from convertVector2Matrix.
  tmp_mat <- convertVector2Matrix(scenario_matrix[1, ])
  colnames(trials_unique_calc) <- colnames(tmp_mat)
  
  n_cohorts <- ncol(n_resp)
  n_responders_u <- trials_unique_calc[, seq_len(n_cohorts),              drop = FALSE]
  n_subjects_u   <- trials_unique_calc[, seq_len(n_cohorts) + n_cohorts,  drop = FALSE]
  
  # Optional sanity check: now the hash keys really match
  expect_setequal(
    getHashKeys(trials_unique_calc),
    getHashKeys(convertVector2Matrix(scenario_matrix))
  )
  
  # ----- Compute quantiles for the unique trials (pooled Beta model) -----
  quantiles <- c(0.025, 0.5, 0.975)
  j_data    <- list(a = 1, b = 1)  # Beta(1,1)
  
  method_quantiles_list <- list(
    pooled = getPostQuantiles(
      method_name       = "pooled",
      quantiles         = quantiles,
      scenario_data     = list(
        n_subjects   = n_subjects_u,
        n_responders = n_responders_u
      ),
      calc_differences  = NULL,
      j_parameters      = NULL,
      j_model_file      = NULL,
      j_data            = j_data,
      n_mcmc_iterations = 1000,
      save_path         = NULL,
      save_trial        = NULL
    )
  )
  
  # ----- Call mapUniqueTrials -----
  out <- mapUniqueTrials(
    scenario_list              = scenario_list,
    method_quantiles_list      = method_quantiles_list,
    trials_unique_calc         = trials_unique_calc,
    applicable_previous_trials = FALSE
  )
  
  expect_type(out, "list")
  expect_identical(names(out), "scenario_1")
  
  scen1 <- out[["scenario_1"]]
  expect_true(is.list(scen1))
  expect_true("pooled" %in% names(scen1))
  
  # The per-trial matrices returned by mapUniqueTrials should match
  # exactly the ones produced by getPostQuantiles for the unique trials
  expect_identical(scen1$pooled[[1]], method_quantiles_list$pooled[[1]])
  expect_identical(scen1$pooled[[2]], method_quantiles_list$pooled[[2]])
})
