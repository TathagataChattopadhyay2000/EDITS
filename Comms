test_that("getGoDecisions handles list evidence_levels/boundary_rules and length checks", {
  set.seed(123)

  scenarios_list <- simulateScenarios(
    n_subjects_list     = list(c(10, 15)),
    response_rates_list = list(c(0.2, 0.3)),
    n_trials            = 3
  )

  analyses_list <- performAnalyses(
    scenario_list     = scenarios_list,
    target_rates      = c(0.2, 0.2),
    n_mcmc_iterations = 50
  )

  cohort_names <- c("p_1", "p_2")
  base_ev      <- c(0.9, 0.9)
  base_rule    <- quote(c(TRUE, TRUE))

  # How many methods do we actually have?
  method_names <- analyses_list[[1]]$analysis_parameters$method_names
  k_methods    <- length(method_names)

  ## 1) evidence_levels passed as a list — should still work
  dec_list_ev <- getGoDecisions(
    analyses_list   = analyses_list,
    cohort_names    = cohort_names,
    evidence_levels = list(base_ev),
    boundary_rules  = base_rule
  )

  scen1 <- dec_list_ev[[1]]

  # gamma_levels stored in decision_rules should contain the values of base_ev
  stored_gamma      <- scen1$decision_rules$gamma_levels
  stored_gamma_flat <- unlist(stored_gamma, use.names = FALSE)
  expect_true(all(base_ev %in% stored_gamma_flat))

  ## 2) boundary_rules passed as a list of length == number of methods — should work
  #    (we replicate base_rule for each method)
  boundary_rules_list <- rep(list(base_rule), k_methods)

  dec_list_br <- getGoDecisions(
    analyses_list   = analyses_list,
    cohort_names    = cohort_names,
    evidence_levels = base_ev,
    boundary_rules  = boundary_rules_list
  )

  scen1b <- dec_list_br[[1]]

  stored_rules <- scen1b$decision_rules$boundary_rules
  # Just check it's not empty and contains something resembling our base_rule
  expect_true(length(stored_rules) >= 1)
  # The exact structure may differ, so we avoid overly strict structural checks

  ## 3) Too many boundary_rules vs method_names -> must error
  too_many_rules <- rep(list(base_rule), k_methods + 1L)

  expect_error(
    getGoDecisions(
      analyses_list   = analyses_list,
      cohort_names    = cohort_names,
      evidence_levels = base_ev,
      boundary_rules  = too_many_rules
    ),
    "boundary_rules",
    ignore.case = TRUE
  )

  ## 4) Too many evidence_levels vs method_names -> must error
  too_many_ev <- rep(list(base_ev), k_methods + 1L)

  expect_error(
    getGoDecisions(
      analyses_list   = analyses_list,
      cohort_names    = cohort_names,
      evidence_levels = too_many_ev,
      boundary_rules  = base_rule
    ),
    "evidence_levels",
    ignore.case = TRUE
  )
})
